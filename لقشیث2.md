<?php
error_reporting(E_ALL);
ini_set('display_errors', 1);

// Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø¯ÛŒØªØ§Ø¨ÛŒØ³
$host = 'localhost';
$dbname = 'student';
$user = 'root';
$pass = '';

try {
    $pdo = new PDO("mysql:host=$host;dbname=$dbname;charset=utf8mb4", $user, $pass);
    $pdo->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
} catch(Exception $e) {
    die("Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø¯ÛŒØªØ§Ø¨ÛŒØ³: " . $e->getMessage());
}

// Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¬ÙˆØ¯ Ø³ØªÙˆÙ† date_update
$check_column = $pdo->prepare("SHOW COLUMNS FROM studen LIKE 'date_update'");
$check_column->execute();
if (!$check_column->fetch()) {
    $pdo->exec("ALTER TABLE studen ADD COLUMN date_update DATETIME NULL");
}

// Ú¯Ø±ÙØªÙ† id Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²
if (!isset($_GET['id'])) die("Ú©Ø§Ø±Ø¨Ø± Ù…Ø´Ø®Øµ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.");
$user_id = (int)$_GET['id'];

// Ù…Ø´Ø®ØµØ§Øª Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²
$stmt = $pdo->prepare("SELECT id, f_name, l_name FROM stude WHERE id=?");
$stmt->execute([$user_id]);
$userData = $stmt->fetch(PDO::FETCH_ASSOC);
if (!$userData) die("Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ² ÛŒØ§ÙØª Ù†Ø´Ø¯.");

// Ù…ØªØºÛŒØ±Ù‡Ø§
$lessons = ['ÙØ§Ø±Ø³ÛŒ','Ø±ÛŒØ§Ø¶ÛŒ','Ù‚Ø±Ø¢Ù†','Ø¯ÛŒÙ†ÛŒ','ØªØ§Ø±ÛŒØ®','Ù‡Ù†Ø±','ÙˆØ±Ø²Ø´'];
$message = '';
$edit_mode = false;
$edit_data = null;

// ğŸ“ŒğŸ“ŒğŸ“Œ Ø¢Ù…Ø§Ø± ÛŒÚ© Ù…Ø§Ù‡ Ø§Ø®ÛŒØ± (Û³Û° Ø±ÙˆØ² Ú¯Ø°Ø´ØªÙ‡)
$start_date = date('Y-m-d H:i:s', strtotime('-30 days'));
$end_date   = date('Y-m-d H:i:s');

// ØªØ¹Ø¯Ø§Ø¯ Ø«Ø¨Øª Ù†Ù…Ø±Ù‡â€ŒÙ‡Ø§
$stmt_register_count = $pdo->prepare("
    SELECT COUNT(*) FROM studen 
    WHERE user_id=?
    AND date_time BETWEEN ? AND ?
");
$stmt_register_count->execute([$user_id, $start_date, $end_date]);
$register_count = $stmt_register_count->fetchColumn();

// ØªØ¹Ø¯Ø§Ø¯ ÙˆÛŒØ±Ø§ÛŒØ´â€ŒÙ‡Ø§
$stmt_edit_count = $pdo->prepare("
    SELECT COUNT(*) FROM studen 
    WHERE user_id=?
    AND date_update IS NOT NULL
    AND date_update BETWEEN ? AND ?
");
$stmt_edit_count->execute([$user_id, $start_date, $end_date]);
$edit_count = $stmt_edit_count->fetchColumn();

// Ú¯Ø±ÙØªÙ† Ù†Ù…Ø±Ø§Øª
$stmt_scores = $pdo->prepare("SELECT id, name_dars, score, date_time, date_update FROM studen WHERE user_id=? ORDER BY id DESC");
$stmt_scores->execute([$user_id]);
$scores = $stmt_scores->fetchAll(PDO::FETCH_ASSOC);

// Ø­Ø§Ù„Øª ÙˆÛŒØ±Ø§ÛŒØ´
if (isset($_GET['edit']) && !empty($_GET['edit']) && is_numeric($_GET['edit'])) {
    $stmt_edit = $pdo->prepare("SELECT id, name_dars, score FROM studen WHERE id=? AND user_id=?");
    $stmt_edit->execute([(int)$_GET['edit'], $user_id]);
    $edit_data = $stmt_edit->fetch(PDO::FETCH_ASSOC);
    if ($edit_data) $edit_mode = true;
}

// Ù¾Ø±Ø¯Ø§Ø²Ø´ ÙØ±Ù…
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    if (isset($_POST['edit_id']) && !empty($_POST['edit_id'])) {
        // ÙˆÛŒØ±Ø§ÛŒØ´
        if (isset($_POST['score']) && is_numeric($_POST['score'])) {
            $score = (int)$_POST['score'];
            $edit_id = (int)$_POST['edit_id'];
            
            if ($score < 0 || $score > 20) {
                $message = "Ù†Ù…Ø±Ù‡ Ø¨Ø§ÛŒØ¯ Ø¨ÛŒÙ† 0 ØªØ§ 20 Ø¨Ø§Ø´Ø¯.";
            } else {
                $current_datetime = date('Y-m-d H:i:s');
                $stmtUpdate = $pdo->prepare("UPDATE studen SET score=?, date_update=? WHERE id=? AND user_id=?");
                $stmtUpdate->execute([$score, $current_datetime, $edit_id, $user_id]);
                
                if ($stmtUpdate->rowCount() > 0) {
                    header("Location: ?id=" . $user_id . "&success=edited");
                    exit();
                } else {
                    $message = "Ø®Ø·Ø§ Ø¯Ø± ÙˆÛŒØ±Ø§ÛŒØ´ Ù†Ù…Ø±Ù‡!";
                }
            }
        }
    } else {
        // Ø«Ø¨Øª Ø¬Ø¯ÛŒØ¯
        if (isset($_POST['score'], $_POST['name_dars']) && is_numeric($_POST['score'])) {
            $score = (int)$_POST['score'];
            $name_dars = trim($_POST['name_dars']);
            
            if ($score < 0 || $score > 20) {
                $message = "Ù†Ù…Ø±Ù‡ Ø¨Ø§ÛŒØ¯ Ø¨ÛŒÙ† 0 ØªØ§ 20 Ø¨Ø§Ø´Ø¯.";
            } elseif (empty($name_dars)) {
                $message = "Ù„Ø·ÙØ§Ù‹ Ù†Ø§Ù… Ø¯Ø±Ø³ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.";
            } else {
                $current_datetime = date('Y-m-d H:i:s');
                
                $stmtCheck = $pdo->prepare("SELECT id FROM studen WHERE user_id=? AND name_dars=?");
                $stmtCheck->execute([$user_id, $name_dars]);
                $exists = $stmtCheck->fetch();

                if ($exists) {
                    $stmtUpdate = $pdo->prepare("UPDATE studen SET score=?, date_update=? WHERE id=?");
                    $stmtUpdate->execute([$score, $current_datetime, $exists['id']]);
                    $message = "Ù†Ù…Ø±Ù‡ Ø¨Ø±Ø§ÛŒ Ø¯Ø±Ø³ {$name_dars} Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯ âœ…";
                } else {
                    $stmtInsert = $pdo->prepare("INSERT INTO studen (user_id, name_dars, score, date_time) VALUES (?,?,?,?)");
                    $stmtInsert->execute([$user_id, $name_dars, $score, $current_datetime]);
                    $message = "Ù†Ù…Ø±Ù‡ Ø¨Ø±Ø§ÛŒ Ø¯Ø±Ø³ {$name_dars} Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯ âœ…";
                }
            }
        }
    }
}

// Ù¾ÛŒØ§Ù… Ù…ÙˆÙÙ‚ÛŒØª
if (isset($_GET['success']) && $_GET['success'] == 'edited') {
    $message = "Ù†Ù…Ø±Ù‡ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ÙˆÛŒØ±Ø§ÛŒØ´ Ø´Ø¯ âœ…";
}
?>

<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø«Ø¨Øª Ùˆ ÙˆÛŒØ±Ø§ÛŒØ´ Ù†Ù…Ø±Ø§Øª</title>

<style>
/* ÙÙ‚Ø· CSS Ù†Ø¦ÙˆÙ†ÛŒ Ø¬Ø¯ÛŒØ¯ */
*{margin:0;padding:0;box-sizing:border-box;font-family:'Vazirmatn',sans-serif}
body{background:#000;color:#fff;display:flex;justify-content:center;align-items:flex-start;min-height:100vh;padding:20px}
.container{width:100%;max-width:900px;background:rgba(20,20,20,.7);backdrop-filter:blur(15px);padding:30px;border-radius:25px;box-shadow:0 0 25px #ff004080,inset 0 0 25px #ff004010;border:1px solid #ff004030}
h2{text-align:center;color:#ff0037;font-size:32px;margin-bottom:25px;text-shadow:0 0 12px #ff0040}
h3{color:#ff6baa;margin:25px 0 15px;text-shadow:0 0 10px #ff6baa}
.user-info{background:#17000b;border:1px solid #ff004030;padding:16px;border-radius:12px;text-align:center;box-shadow:0 0 12px #ff004020;font-size:18px;margin-bottom:20px}
.stats-box{background:#111;border:1px solid #00ff7f50;padding:18px;border-radius:12px;margin-bottom:25px;box-shadow:0 0 15px #00ff7f30;text-align:center}
.stats-box span{color:#00ff9d;font-size:20px;font-weight:bold}
form{margin:20px 0}
input,button,.edit-btn{width:100%;padding:12px;border-radius:10px;margin:8px 0;border:none;font-size:16px;transition:.3s}
input{background:#151515;color:#ff77cc;border:1px solid #ff77cc40}
input:focus{outline:none;border-color:#ff77cc;box-shadow:0 0 12px #ff77cc}
button{background:linear-gradient(135deg,#ff0040,#79002b);color:#fff;box-shadow:0 0 10px #ff0040;cursor:pointer}
button:hover{transform:translateY(-3px);box-shadow:0 0 20px #ff0055}
.edit-btn{background:linear-gradient(135deg,#ffaa00,#cc7a00);width:auto;display:inline-block;color:#fff;box-shadow:0 0 10px #ffae00}
.edit-btn:hover{transform:scale(1.1)}
table{width:100%;border-collapse:collapse;margin-top:20px}
thead th{background:#280014;padding:14px;color:#ff4070;border-radius:8px}
tbody td{padding:12px;background:#151515;border-bottom:1px solid #333}
tbody tr:hover td{background:#200010;box-shadow:inset 0 0 10px #ff004020}
.datetime-info{font-size:12px;color:#ff88c2;opacity:.8;margin-top:2px}
</style>

</head>
<body>

<div class="container">

    <h2>ğŸ“ Ø«Ø¨Øª Ùˆ ÙˆÛŒØ±Ø§ÛŒØ´ Ù†Ù…Ø±Ø§Øª</h2>

    <div class="user-info">
        <strong>Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²:</strong>
        <?php echo $userData['f_name'] . " " . $userData['l_name']; ?>
    </div>

    <!-- ğŸ“Œ Ø¢Ù…Ø§Ø± ÛŒÚ© Ù…Ø§Ù‡ Ú¯Ø°Ø´ØªÙ‡ -->
    <div class="stats-box">
        <div>ğŸ“… Ø¢Ù…Ø§Ø± Û³Û° Ø±ÙˆØ² Ø§Ø®ÛŒØ±</div>
        ğŸ”¹ Ø«Ø¨Øª Ù†Ù…Ø±Ù‡: <span><?php echo $register_count; ?></span><br>
        ğŸ”¸ ÙˆÛŒØ±Ø§ÛŒØ´ Ù†Ù…Ø±Ù‡: <span style="color:#ffaa00;"><?php echo $edit_count; ?></span>
    </div>

    <h3><?php echo $edit_mode ? "âœï¸ ÙˆÛŒØ±Ø§ÛŒØ´ Ù†Ù…Ø±Ù‡" : "â• Ø«Ø¨Øª Ù†Ù…Ø±Ù‡ Ø¬Ø¯ÛŒØ¯"; ?></h3>

    <form method="post">
        <?php if ($edit_mode): ?>
            <input type="hidden" name="edit_id" value="<?php echo $edit_data['id']; ?>">
            <div class="lesson-display">
                Ø¯Ø±Ø³: <strong><?php echo $edit_data['name_dars']; ?></strong>
            </div>
            <input type="number" name="score" min="0" max="20" value="<?php echo $edit_data['score']; ?>" required>
            <button>ğŸ’¾ Ø°Ø®ÛŒØ±Ù‡</button>
        <?php else: ?>
            <input list="lessons" name="name_dars" placeholder="Ø§Ù†ØªØ®Ø§Ø¨ ÛŒØ§ ØªØ§ÛŒÙ¾ Ø¯Ø±Ø³" required>
            <datalist id="lessons">
                <?php foreach($lessons as $lesson): ?>
                    <option value="<?php echo $lesson; ?>">
                <?php endforeach; ?>
            </datalist>

            <input type="number" name="score" min="0" max="20" placeholder="Ù†Ù…Ø±Ù‡ (0 ØªØ§ 20)" required>
            <button>Ø«Ø¨Øª Ù†Ù…Ø±Ù‡</button>
        <?php endif; ?>
    </form>

    <?php if ($message): ?>
        <div class="message" style="background:#220000;padding:12px;border-radius:10px;margin:10px 0;">
            <?php echo $message; ?>
        </div>
    <?php endif; ?>

    <?php if (!empty($scores)): ?>
        <h3>ğŸ“Š Ù†Ù…Ø±Ø§Øª Ø«Ø¨Øª Ø´Ø¯Ù‡</h3>

        <table>
            <thead>
                <tr>
                    <th>Ø±Ø¯ÛŒÙ</th>
                    <th>Ø¯Ø±Ø³</th>
                    <th>Ù†Ù…Ø±Ù‡</th>
                    <th>Ø«Ø¨Øª</th>
                    <th>ÙˆÛŒØ±Ø§ÛŒØ´</th>
                    <th>Ø¹Ù…Ù„ÛŒØ§Øª</th>
                </tr>
            </thead>
            <tbody>
                <?php foreach($scores as $i => $score): ?>
                <tr>
                    <td><?php echo $i+1; ?></td>
                    <td><?php echo $score['name_dars']; ?></td>
                    <td><?php echo $score['score']; ?></td>
                    <td>
                        <?php echo date("Y/m/d H:i", strtotime($score['date_time'])); ?>
                    </td>
                    <td>
                        <?php echo $score['date_update'] ? date("Y/m/d H:i", strtotime($score['date_update'])) : "--"; ?>
                    </td>
                    <td>
                        <a class="edit-btn" href="?id=<?php echo $user_id; ?>&edit=<?php echo $score['id']; ?>">ÙˆÛŒØ±Ø§ÛŒØ´</a>
                    </td>
                </tr>
                <?php endforeach ?>
            </tbody>
        </table>

    <?php else: ?>
        <div style="padding:20px;background:#111;text-align:center;border-radius:12px;">
            Ù‡Ù†ÙˆØ² Ù†Ù…Ø±Ù‡â€ŒØ§ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.
        </div>
    <?php endif; ?>

</div>

</body>
</html>
